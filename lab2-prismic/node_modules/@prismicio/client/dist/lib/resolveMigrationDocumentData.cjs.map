{"version":3,"file":"resolveMigrationDocumentData.cjs","sources":["../../../src/lib/resolveMigrationDocumentData.ts"],"sourcesContent":["import type { MigrationLinkToMediaField } from \"../types/migration/Asset\"\nimport {\n\ttype MigrationImage,\n\ttype MigrationLinkToMedia,\n\ttype MigrationRTImageNode,\n\tPrismicMigrationAsset,\n} from \"../types/migration/Asset\"\nimport type {\n\tMigrationContentRelationship,\n\tMigrationContentRelationshipField,\n} from \"../types/migration/ContentRelationship\"\nimport { PrismicMigrationDocument } from \"../types/migration/Document\"\nimport type { FilledImageFieldImage } from \"../types/value/image\"\nimport type { LinkField } from \"../types/value/link\"\nimport { LinkType } from \"../types/value/link\"\nimport type { RTImageNode } from \"../types/value/richText\"\nimport { RichTextNodeType } from \"../types/value/richText\"\n\nimport * as isFilled from \"../helpers/isFilled\"\nimport type { Migration } from \"../Migration\"\n\nimport * as isMigration from \"./isMigrationValue\"\n\n/**\n * Resolves a migration content relationship to a content relationship field.\n *\n * @param relation - Content relationship to resolve.\n *\n * @returns Resolved content relationship field.\n */\nexport async function resolveMigrationContentRelationship(\n\trelation: MigrationContentRelationship,\n): Promise<MigrationContentRelationshipField> {\n\tif (typeof relation === \"function\") {\n\t\treturn resolveMigrationContentRelationship(await relation())\n\t}\n\n\tif (relation instanceof PrismicMigrationDocument) {\n\t\treturn relation.document.id\n\t\t\t? { link_type: LinkType.Document, id: relation.document.id }\n\t\t\t: { link_type: LinkType.Document }\n\t}\n\n\tif (relation) {\n\t\tif (\n\t\t\tisMigration.contentRelationship(relation.id) ||\n\t\t\ttypeof relation.id === \"function\"\n\t\t) {\n\t\t\treturn {\n\t\t\t\t...(await resolveMigrationContentRelationship(relation.id)),\n\t\t\t\t// TODO: Remove when link text PR is merged\n\t\t\t\t// @ts-expect-error - Future-proofing for link text\n\t\t\t\ttext: relation.text,\n\t\t\t}\n\t\t}\n\n\t\treturn { link_type: LinkType.Document, id: relation.id }\n\t}\n\n\treturn { link_type: LinkType.Document }\n}\n\n/**\n * Resolves a migration image to an image field.\n *\n * @param migrationAsset - Asset to resolve.\n * @param migration - Migration instance.\n * @param withThumbnails - Whether to include thumbnails.\n *\n * @returns Resolved image field.\n */\nexport const resolveMigrationImage = (\n\timage: MigrationImage,\n\tmigration: Migration,\n\twithThumbnails?: boolean,\n): FilledImageFieldImage | undefined => {\n\tconst { id: master, ...thumbnails } =\n\t\timage instanceof PrismicMigrationAsset ? { id: image } : image\n\n\tconst asset = migration._assets.get(master.config.id)?.asset\n\tconst maybeInitialField = master.originalField\n\n\tif (asset) {\n\t\tconst parameters = (maybeInitialField?.url || asset.url).split(\"?\")[1]\n\t\tconst url = `${asset.url.split(\"?\")[0]}${parameters ? `?${parameters}` : \"\"}`\n\t\tconst dimensions: FilledImageFieldImage[\"dimensions\"] = {\n\t\t\twidth: asset.width!,\n\t\t\theight: asset.height!,\n\t\t}\n\t\tconst edit: FilledImageFieldImage[\"edit\"] =\n\t\t\tmaybeInitialField && \"edit\" in maybeInitialField\n\t\t\t\t? maybeInitialField?.edit\n\t\t\t\t: { x: 0, y: 0, zoom: 1, background: \"transparent\" }\n\n\t\t// We give priority to the asset's specific alt text, then the image's general alt text\n\t\tconst alt = master.config.alt || asset.alt || null\n\n\t\tconst resolvedThumbnails: Record<string, FilledImageFieldImage> = {}\n\t\tif (withThumbnails) {\n\t\t\tfor (const [name, thumbnail] of Object.entries(thumbnails)) {\n\t\t\t\tconst resolvedThumbnail = resolveMigrationImage(thumbnail, migration)\n\t\t\t\tif (resolvedThumbnail) {\n\t\t\t\t\tresolvedThumbnails[name] = resolvedThumbnail\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tid: asset.id,\n\t\t\turl,\n\t\t\tdimensions,\n\t\t\tedit,\n\t\t\talt: alt,\n\t\t\tcopyright: asset.credits || null,\n\t\t\t...resolvedThumbnails,\n\t\t}\n\t}\n}\n\n/**\n * Resolves a migration rich text image node to a regular rich text image node.\n *\n * @param rtImageNode - Migration rich text image node to resolve.\n * @param migration - Migration instance.\n *\n * @returns Resolved rich text image node.\n */\nexport const resolveMigrationRTImageNode = async (\n\trtImageNode: MigrationRTImageNode,\n\tmigration: Migration,\n): Promise<RTImageNode | undefined> => {\n\tconst image = resolveMigrationImage(rtImageNode.id, migration)\n\n\tif (image) {\n\t\tconst linkTo = (await resolveMigrationDocumentData(\n\t\t\trtImageNode.linkTo,\n\t\t\tmigration,\n\t\t)) as LinkField\n\n\t\treturn {\n\t\t\t...image,\n\t\t\ttype: RichTextNodeType.image,\n\t\t\tlinkTo: isFilled.link(linkTo) ? linkTo : undefined,\n\t\t}\n\t}\n}\n\n/**\n * Resolves a migration link to media to a regular link to media field.\n *\n * @param linkToMedia - Migration link to media to resolve.\n * @param migration - Migration instance.\n *\n * @returns Resolved link to media field.\n */\nexport const resolveMigrationLinkToMedia = (\n\tlinkToMedia: MigrationLinkToMedia,\n\tmigration: Migration,\n): MigrationLinkToMediaField => {\n\tconst asset = migration._assets.get(linkToMedia.id.config.id)?.asset\n\n\tif (asset) {\n\t\treturn {\n\t\t\tid: asset.id,\n\t\t\tlink_type: LinkType.Media,\n\t\t\ttext: linkToMedia.text,\n\t\t}\n\t}\n\n\treturn { link_type: LinkType.Media }\n}\n\n/**\n * Resolves a migration document data to actual data ready to be sent to the\n * Migration API.\n *\n * @param input - Migration link to media to resolve.\n * @param migration - Migration instance.\n *\n * @returns Resolved data.\n */\nexport async function resolveMigrationDocumentData(\n\tinput: unknown,\n\tmigration: Migration,\n): Promise<unknown> {\n\t// Migration fields\n\tif (isMigration.contentRelationship(input)) {\n\t\treturn resolveMigrationContentRelationship(input)\n\t}\n\n\tif (isMigration.image(input)) {\n\t\treturn resolveMigrationImage(input, migration, true)\n\t}\n\n\tif (isMigration.linkToMedia(input)) {\n\t\treturn resolveMigrationLinkToMedia(input, migration)\n\t}\n\n\tif (isMigration.rtImageNode(input)) {\n\t\treturn resolveMigrationRTImageNode(input, migration)\n\t}\n\n\tif (typeof input === \"function\") {\n\t\treturn await resolveMigrationDocumentData(await input(), migration)\n\t}\n\n\t// Object traversing\n\tif (Array.isArray(input)) {\n\t\tconst res = []\n\n\t\tfor (const element of input) {\n\t\t\tres.push(await resolveMigrationDocumentData(element, migration))\n\t\t}\n\n\t\treturn res.filter(Boolean)\n\t}\n\n\tif (input && typeof input === \"object\") {\n\t\tconst res: Record<PropertyKey, unknown> = {}\n\n\t\tfor (const key in input) {\n\t\t\tres[key] = await resolveMigrationDocumentData(\n\t\t\t\tinput[key as keyof typeof input],\n\t\t\t\tmigration,\n\t\t\t)\n\t\t}\n\n\t\treturn res\n\t}\n\n\t// Primitives\n\treturn input\n}\n"],"names":["PrismicMigrationDocument","LinkType","isMigration.contentRelationship","PrismicMigrationAsset","RichTextNodeType","isFilled.link","isMigration.image","isMigration.linkToMedia","isMigration.rtImageNode"],"mappings":"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"}